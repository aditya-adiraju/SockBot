name: Build and Deploy Discord Bot to Google Compute Engine

on:
  push:
    branches:
      - main
env:
  PROJECT_ID: ${{ secrets.GCE_PROJECT }}
  GCE_INSTANCE: ${{ secrets.GCE_INSTANCE }}
  GCE_INSTANCE_ZONE: ${{ secrets.GCE_ZONE }}

jobs:
  setup-build-push-deploy:
    name: Setup build push and deploy
    runs-on: ubuntu-latest
  
    steps:
      - id: Checkout
        uses: actions/checkout@v4
      
      - id: gcloud auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCE_SA_KEY }}'
          
      - id: set up docker configuration 
        run: |
          gcloud auth configure-docker us-west1-docker.pkg.dev

      - id: Build and push Docker image
        run: |
          docker compose -f docker-compose.yml build sockbot
          docker compose -f docker-compose.yml push sockbot

      - id: 'compute-ssh'
        uses: 'google-github-actions/ssh-compute@v1'
        with:
          instance_name: 'example-instance'
          zone: ${{ secrets.GCE_ZONE }}
          ssh_private_key: '${{ secrets.GCP_SSH_PRIVATE_KEY }}'
          script: |
            cd /home/sockie/sockbot
            docker compose down
            docker compose pull
            docker compose up -d